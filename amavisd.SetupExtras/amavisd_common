
# Install new config directory
_config_dir="/Library/Server/Mail/Config/amavisd"
if [ ! -d $_config_dir ]; then
  mkdir -p $_config_dir;
fi

# Install default config files
_config_file="$_config_dir/amavisd.conf"
_default_config="$_server_root/private/etc/amavisd.conf.default"
if [ ! -e $_config_file ]; then
  if [ -e $_default_config ]; then
    cp $_default_config $_config_file
  fi
fi

# Install languages directory
_dst_lang_dir="/Library/Server/Mail/Data/amavisd/languages"
if [ ! -d $_dst_lang_dir ]; then
  mkdir -p $_dst_lang_dir
fi

# copy languages
_src_lang_dir="$_server_root/private/etc/mail/amavisd/languages"
# copy languages
if [ -d $_src_lang_dir ]; then
  cp -rpf "$_src_lang_dir/"* "$_dst_lang_dir"
fi

# Install language templates
_language_dir="en.lproj";
_languages_dir="$_server_root/private/etc/mail/amavisd/languages"
if [ -d "$_languages_dir/$_language_dir" ]; then
  cp -rpf "$_languages_dir/$_language_dir" "$_dst_lang_dir/"
fi

# Set language templates
_language_dir="en.lproj";
_default_lang=`/usr/libexec/PlistBuddy -c "print AppleLanguages:0" /Library/Preferences/.GlobalPreferences.plist`
if [ "$_default_lang" != "" ]; then
  _language_dir="$_default_lang.lproj";
fi

# Validate language directory, default to en
if [ ! -e "$_dst_lang_dir/$_language_dir/charset" ]; then
  _language_dir="en.lproj";
fi

_config_file_tmp="$_config_dir/amavisd.conf.tmp"
if [ -e $_config_file ]; then
  # only set the key if it is enabled
  if /usr/bin/grep "^read_l10n_templates" "$_config_file" > /dev/null ; then
    # set key if language directory succeeded, otherwise disable key
    _key_template="read_l10n_templates('\/Library\/Server\/Mail\/Data\/amavisd\/languages\/$_language_dir');"
    # set key
    sed -e "s/^read_l10n_templates.*/$_key_template/" "$_config_file" > "$_config_file_tmp"
    if [ -e "$_config_file_tmp" ] ; then
      /bin/rm "$_config_file"
      /bin/mv "$_config_file_tmp" "$_config_file"
    fi
  fi
fi

if [ -e $_config_file ]; then
  chown root:wheel $_config_file
  chmod 644 $_config_file
fi

##################
# Create log files
_amavis_log_dir=/Library/Logs/Mail
if [ ! -d $_amavis_log_dir ]; then
  mkdir -p $_amavis_log_dir
fi
chown root:admin $_amavis_log_dir

_amavis_log=$_amavis_log_dir/amavis.log
if [ ! -e $_amavis_log ]; then
  touch $_amavis_log
fi
chmod 640 $_amavis_log
chown _amavisd:admin $_amavis_log

#################
# Setup data dirs
_amavis_dir=/Library/Server/Mail/Data/scanner/amavis
if [ ! -d $_amavis_dir ]; then
  mkdir -p $_amavis_dir
fi

# db dir
if [ ! -d $_amavis_dir/db ]; then
  mkdir -p $_amavis_dir/db
fi

# tmp dir
if [ ! -d $_amavis_dir/tmp ]; then
  mkdir -p $_amavis_dir/tmp
fi

# dir ownership
chown -R _amavisd:_amavisd $_amavis_dir

# virus email dir
_virusmails_dir=/Library/Server/Mail/Data/scanner/virusmails
if [ ! -d $_virusmails_dir ]; then
  mkdir -p $_virusmails_dir
fi
chown -R _amavisd:_amavisd $_virusmails_dir

_amavis_sa_dir="/Library/Server/Mail/Data/scanner/amavis/.spamassassin"
_clamav_sa_dir="/Library/Server/Mail/Data/scanner/clamav/.spamassassin"
if [ ! -d $_amavis_sa_dir ]; then
  if [ -d $_clamav_sa_dir ]; then
    cp -r $_clamav_sa_dir $_amavis_sa_dir
  else
    mkdir $_amavis_sa_dir
  fi
fi
chown -R _amavisd:_amavisd $_amavis_sa_dir

##################
# whitelist_sender
if [ ! -e $_amavis_dir/whitelist_sender ]; then
  echo "\n" > $_amavis_dir/whitelist_sender
fi
chown _amavisd:_amavisd $_amavis_dir/whitelist_sender
chmod 644 $_amavis_dir/whitelist_sender

